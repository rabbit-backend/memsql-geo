<!doctype html>
<html lang="en">
    <head>
        <meta charset="utf-8" />
        <title>Multi-WKT EPSG:3857 Viewer + XYZ Tiles</title>
        <meta name="viewport" content="width=device-width,initial-scale=1" />

        <link
            rel="stylesheet"
            href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"
        />
        <style>
            html,
            body,
            #map {
                height: 100%;
                margin: 0;
                padding: 0;
            }
            #controls {
                position: absolute;
                z-index: 1000;
                left: 10px;
                top: 10px;
                background: rgba(255, 255, 255, 0.95);
                padding: 10px;
                border-radius: 6px;
                width: 380px;
                box-shadow: 0 2px 6px rgba(0, 0, 0, 0.3);
            }
            .wktBox {
                width: 100%;
                height: 90px;
                margin-bottom: 6px;
                font-family: monospace;
            }
            .btn {
                display: inline-block;
                padding: 6px 10px;
                background: #3388ff;
                color: #fff;
                border-radius: 4px;
                cursor: pointer;
                margin-top: 6px;
                text-decoration: none;
            }
            .btnGray {
                background: #777;
            }
            #tileInfo {
                margin-top: 8px;
                font-size: 13px;
                color: #333;
                white-space: pre;
            }
        </style>
    </head>
    <body>
        <div id="controls">
            <strong>WKT(s) in EPSG:3857:</strong><br />
            <div id="wktContainer"></div>

            <a id="addWktBtn" class="btn" style="background: #44aa44"
                >+ Add WKT</a
            >
            <br />

            <a id="plotBtn" class="btn">Plot WKTs</a>
            <a id="clearBtn" class="btn btnGray" style="margin-left: 8px"
                >Clear</a
            >

            <div id="tileInfo"></div>
        </div>

        <div id="map"></div>

        <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
        <script src="https://unpkg.com/wellknown@0.5.0/wellknown.js"></script>
        <script src="https://cdn.jsdelivr.net/npm/proj4@2.10.0/dist/proj4.js"></script>

        <script>
            // ------------------------------------------------
            // PROJECTIONS
            // ------------------------------------------------
            proj4.defs(
                "EPSG:3857",
                "+proj=merc +lon_0=0 +k=1 +x_0=0 +y_0=0 +datum=WGS84 +units=m +no_defs",
            );
            proj4.defs("EPSG:4326", "+proj=longlat +datum=WGS84 +no_defs");
            const to4326 = (x, y) => proj4("EPSG:3857", "EPSG:4326", [x, y]);

            // ------------------------------------------------
            // MAP SETUP
            // ------------------------------------------------
            const map = L.map("map").setView([39.5, -98.35], 4);
            L.tileLayer("https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png", {
                maxZoom: 19,
            }).addTo(map);

            const wktLayer = L.layerGroup().addTo(map);
            let tileRect = null;

            // ------------------------------------------------
            // MULTIPLE WKT INPUT HANDLING
            // ------------------------------------------------
            const wktContainer = document.getElementById("wktContainer");

            function addWktBox(text = "") {
                const div = document.createElement("div");

                const textarea = document.createElement("textarea");
                textarea.className = "wktBox";
                textarea.value = text;

                const removeBtn = document.createElement("a");
                removeBtn.textContent = "Remove";
                removeBtn.className = "btn btnGray";
                removeBtn.style.marginBottom = "10px";
                removeBtn.onclick = () => div.remove();

                div.appendChild(textarea);
                div.appendChild(removeBtn);
                wktContainer.appendChild(div);
            }

            // initial two
            addWktBox(
                "POLYGON((-13618263 4547543,-13618263 4548543,-13617263 4548543,-13617263 4547543,-13618263 4547543))",
            );
            addWktBox(
                "POLYGON((-13617263 4547543,-13617263 4548543,-13616263 4548543,-13616263 4547543,-13617263 4547543))",
            );

            document.getElementById("addWktBtn").onclick = () => addWktBox();

            // ------------------------------------------------
            // WKT PARSING + PLOTTING
            // ------------------------------------------------
            function parseWKT_3857(wktStr) {
                const geom = wellknown.parse(wktStr);
                if (!geom) return null;

                function transformCoords(coords) {
                    if (typeof coords[0] === "number") {
                        const [x, y] = coords;
                        return to4326(x, y);
                    }
                    return coords.map(transformCoords);
                }
                geom.coordinates = transformCoords(geom.coordinates);

                return {
                    type: "Feature",
                    properties: { wkt: wktStr },
                    geometry: geom,
                };
            }

            function randomColor() {
                const h = Math.floor(Math.random() * 360);
                return `hsl(${h},80%,55%)`;
            }

            document.getElementById("plotBtn").onclick = () => {
                wktLayer.clearLayers();

                const boxes = Array.from(document.querySelectorAll(".wktBox"));
                const boundsList = [];

                boxes.forEach((b) => {
                    const wkt = b.value.trim();
                    if (!wkt) return;
                    const feat = parseWKT_3857(wkt);
                    if (!feat) return;

                    const color = randomColor();
                    const layer = L.geoJSON(feat, {
                        style: { color, weight: 2, fillOpacity: 0.25 },
                    }).addTo(wktLayer);

                    layer.eachLayer((l) =>
                        l.bindPopup(`<pre>${feat.properties.wkt}</pre>`),
                    );

                    boundsList.push(layer.getBounds());
                });

                if (boundsList.length > 0) {
                    const merged = boundsList.reduce(
                        (acc, b) => acc.extend(b),
                        boundsList[0],
                    );
                    map.fitBounds(merged.pad(0.2));
                }
            };

            document.getElementById("clearBtn").onclick = () =>
                wktLayer.clearLayers();

            // ------------------------------------------------
            // TILE COORD + BBOX EPSG:3857
            // ------------------------------------------------
            function lonLatToTile(lon, lat, z) {
                const x = Math.floor(((lon + 180) / 360) * Math.pow(2, z));
                const latRad = (lat * Math.PI) / 180;
                const y = Math.floor(
                    ((1 -
                        Math.log(Math.tan(latRad) + 1 / Math.cos(latRad)) /
                            Math.PI) /
                        2) *
                        Math.pow(2, z),
                );
                return { x, y, z };
            }

            // compute EPSG:4326 tile WGS bounds
            function tileBounds(x, y, z) {
                const n = Math.pow(2, z);
                const lonL = (x / n) * 360 - 180;
                const lonR = ((x + 1) / n) * 360 - 180;

                const latTop = rad2deg(
                    Math.atan(Math.sinh(Math.PI * (1 - (2 * y) / n))),
                );
                const latBot = rad2deg(
                    Math.atan(Math.sinh(Math.PI * (1 - (2 * (y + 1)) / n))),
                );

                return {
                    sw: [latBot, lonL],
                    se: [latBot, lonR],
                    ne: [latTop, lonR],
                    nw: [latTop, lonL],
                };
            }

            function to3857([lat, lon]) {
                return proj4("EPSG:4326", "EPSG:3857", [lon, lat]);
            }

            function rad2deg(r) {
                return (r * 180) / Math.PI;
            }

            const tileInfoEl = document.getElementById("tileInfo");

            function showTile(latlng) {
                const z = map.getZoom();
                const t = lonLatToTile(latlng.lng, latlng.lat, z);
                const b = tileBounds(t.x, t.y, t.z);

                // convert WGS â†’ 3857
                const p1 = to3857(b.sw);
                const p2 = to3857(b.ne);
                const minX = p1[0],
                    minY = p1[1];
                const maxX = p2[0],
                    maxY = p2[1];

                tileInfoEl.textContent = `Tile:
  X=${t.x}  Y=${t.y}  Z=${t.z}

BBox EPSG:3857:
${minX.toFixed(2)},${minY.toFixed(2)},${maxX.toFixed(2)},${maxY.toFixed(2)}`;

                // highlight tile
                if (tileRect) tileRect.remove();
                tileRect = L.rectangle(
                    [
                        [b.sw[0], b.sw[1]],
                        [b.ne[0], b.ne[1]],
                    ],
                    {
                        color: "#3388ff",
                        weight: 2,
                        fill: false,
                        dashArray: "6 6",
                    },
                ).addTo(map);
            }

            map.on("mousemove", (e) => showTile(e.latlng));
            map.on("zoomend moveend", () => showTile(map.getCenter()));
        </script>
    </body>
</html>
